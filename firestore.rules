rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========

    // Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Get user ID
    function uid() {
      return request.auth.uid;
    }

    // Check if user is a player in this room
    function isPlayerInRoom(roomId) {
      return exists(/databases/$(database)/documents/rooms/$(roomId)/players/$(uid()));
    }

    // Check if user is the host of this room
    function isHost(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId)).data.hostId == uid();
    }

    // ========== ROOMS ==========

    match /rooms/{roomId} {
      // Any authenticated user can read rooms
      // (room code acts as access control for joining, matching ludoRooms pattern)
      allow read: if isAuth();

      // Anyone authenticated can create a room (they become host)
      allow create: if isAuth() && request.resource.data.hostId == uid();

      // Only host can update room status
      allow update: if isAuth() && isHost(roomId);

      // Only host can delete room
      allow delete: if isAuth() && isHost(roomId);

      // ========== PLAYERS SUBCOLLECTION ==========

      match /players/{playerId} {
        // All authenticated users can read player list
        allow read: if isAuth();

        // User can add themselves as a player
        allow create: if isAuth() && playerId == uid();

        // User can update their own player doc (e.g., isReady)
        allow update: if isAuth() && playerId == uid();

        // Host can update/create any player (for bot management)
        allow write: if isAuth() && isHost(roomId);

        // User can remove themselves, host can remove anyone
        allow delete: if isAuth() && (playerId == uid() || isHost(roomId));
      }

      // ========== MATCH SUBCOLLECTION ==========

      match /match/public {
        // All authenticated users can read public match state
        allow read: if isAuth();

        // Only host can write public match state
        allow write: if isAuth() && isHost(roomId);
      }

      // Player hands are stored at: /match/hands/players/{playerId}
      match /match/hands/players/{playerId} {
        // Player can ONLY read their own hand
        allow read: if isAuth() && playerId == uid();

        // Only host can write any hand (anti-cheat)
        allow write: if isAuth() && isHost(roomId);
      }

      // ========== ACTIONS SUBCOLLECTION ==========

      match /actions/{actionId} {
        // All authenticated users can read actions
        allow read: if isAuth();

        // Player can only create actions for themselves
        allow create: if isAuth()
          && request.resource.data.playerId == uid();

        // Only host can update actions (mark as processed)
        allow update: if isAuth() && isHost(roomId);

        // Only host can delete actions (cleanup)
        allow delete: if isAuth() && isHost(roomId);
      }
    }

    // ========== LUDO ROOMS ==========

    // Check if user is the host of a Ludo room
    function isLudoHost(roomId) {
      return get(/databases/$(database)/documents/ludoRooms/$(roomId)).data.hostId == uid();
    }

    // ========== DEBUG LOGS (TEMPORARY) ==========
    // Remove once the "token beyond home path" bug is resolved.

    match /debug_logs/{logId} {
      // Any authenticated user can create a debug log
      allow create: if isAuth();

      // Only readable for admin (no client reads needed)
      allow read: if false;

      // No updates or deletes from client
      allow update, delete: if false;
    }

    match /ludoRooms/{roomId} {
      // Any authenticated user can read rooms
      // (needed for join-by-code queries and public room listing;
      //  room code acts as access control for joining)
      allow read: if isAuth();

      // Anyone authenticated can create a room (they become host)
      allow create: if isAuth() && request.resource.data.hostId == uid();

      // Any authenticated user can update (join, setReady, leave, etc.)
      // App-level logic enforces host-only operations (startGame, endGame)
      allow update: if isAuth();

      // Only host can delete room
      allow delete: if isAuth() && isLudoHost(roomId);

      // ========== MATCH STATE ==========

      match /match/state {
        // Any authenticated user can read game state
        allow read: if isAuth();

        // Only host can write game state
        allow write: if isAuth() && isLudoHost(roomId);
      }

      // ========== PRESENCE ==========

      match /presence/{playerId} {
        // Any authenticated user can read presence
        allow read: if isAuth();

        // Players can only write their own presence
        allow write: if isAuth() && playerId == uid();
      }

      // ========== ACTIONS SUBCOLLECTION ==========

      match /actions/{actionId} {
        // Any authenticated user can read actions
        allow read: if isAuth();

        // Any authenticated user can create actions for themselves
        allow create: if isAuth()
          && request.resource.data.playerId == uid();

        // Only host can update/delete actions
        allow update: if isAuth() && isLudoHost(roomId);
        allow delete: if isAuth() && isLudoHost(roomId);
      }
    }
  }
}
